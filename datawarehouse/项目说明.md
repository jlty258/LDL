# 制造业数据仓库项目说明

## 项目结构

```
datawarehouse/
├── sql/                          # SQL脚本目录
│   ├── 01_init_database.sql      # 数据库初始化
│   ├── 02_ods_tables.sql         # ODS层30张表
│   ├── 03_dwd_tables.sql         # DWD层表结构
│   ├── 04_dws_tables.sql         # DWS层表结构
│   ├── 05_ads_tables.sql         # ADS层表结构
│   ├── 06_generate_test_data.py  # 测试数据生成脚本（最大表10000行）
│   └── 07_complex_etl.sql        # 复杂ETL SQL（超过100行）
├── schedulers/                    # 调度任务配置
│   ├── create_dolphinscheduler_tasks.py  # 创建30个DS任务
│   ├── create_all_airflow_dags.py        # 创建30个Airflow DAG
│   └── README.md                 # 调度任务说明
└── README.md                     # 项目说明
```

## 数据仓库分层

### ODS层（操作数据存储层）- 30张表
1. ods_order_master - 订单主表
2. ods_order_detail - 订单明细表
3. ods_customer_master - 客户主表
4. ods_product_master - 产品主表
5. ods_production_plan - 生产计划表
6. ods_production_order - 生产工单表
7. ods_bom - 物料清单表
8. ods_material_master - 物料主表（最大表，10000行）
9. ods_inventory - 库存表
10. ods_inbound_order - 入库单表
11. ods_inbound_detail - 入库明细表
12. ods_outbound_order - 出库单表
13. ods_outbound_detail - 出库明细表
14. ods_supplier_master - 供应商主表
15. ods_purchase_order - 采购订单表
16. ods_purchase_detail - 采购明细表
17. ods_workshop_master - 车间主表
18. ods_production_line - 生产线表
19. ods_equipment_master - 设备主表
20. ods_equipment_runtime - 设备运行记录表
21. ods_quality_inspection - 质量检验表
22. ods_defect_record - 不合格品记录表
23. ods_employee_master - 员工主表
24. ods_attendance - 考勤记录表
25. ods_warehouse_master - 仓库主表
26. ods_sales_payment - 销售回款表
27. ods_cost_center - 成本中心表
28. ods_cost_detail - 成本明细表
29. ods_factory_master - 工厂主表
30. ods_department_master - 部门主表

### DWD层（数据明细层）
- dwd_order_fact - 订单事实表
- dwd_production_fact - 生产事实表
- dwd_inventory_fact - 库存事实表
- dwd_purchase_fact - 采购事实表
- dwd_quality_fact - 质量事实表
- dwd_equipment_runtime_fact - 设备运行事实表
- dwd_cost_fact - 成本事实表
- dwd_customer_dim - 客户维度表
- dwd_product_dim - 产品维度表
- dwd_material_dim - 物料维度表

### DWS层（数据汇总层）
- dws_order_daily - 订单日汇总表
- dws_production_daily - 生产日汇总表
- dws_inventory_daily - 库存日汇总表
- dws_purchase_daily - 采购日汇总表
- dws_quality_daily - 质量日汇总表
- dws_equipment_runtime_daily - 设备运行日汇总表
- dws_cost_daily - 成本日汇总表

### ADS层（应用数据服务层）
- ads_sales_analysis - 销售分析报表
- ads_production_analysis - 生产分析报表
- ads_inventory_analysis - 库存分析报表
- ads_purchase_analysis - 采购分析报表
- ads_quality_analysis - 质量分析报表
- ads_equipment_efficiency - 设备效率分析报表
- ads_cost_analysis - 成本分析报表
- ads_business_overview - 综合经营分析报表

## 调度任务

### DolphinScheduler - 30个任务
运行脚本创建：
```bash
python datawarehouse/schedulers/create_dolphinscheduler_tasks.py
```

### Airflow - 30个DAG
DAG文件位置：`airflow/dags/`
- ods_01_order_master_etl.py 到 ods_10_purchase_etl.py (10个)
- dwd_01_order_fact_etl.py 到 dwd_07_cost_fact_etl.py (7个)
- dws_01_order_daily_etl.py 到 dws_07_cost_daily_etl.py (7个)
- ads_01_sales_analysis_etl.py 到 ads_06_business_overview_etl.py (6个)

## 初始化步骤

1. 初始化数据库表结构
```bash
mysql -h localhost -P 3306 -u sqluser -psqlpass123 < datawarehouse/sql/01_init_database.sql
mysql -h localhost -P 3306 -u sqluser -psqlpass123 sqlExpert < datawarehouse/sql/02_ods_tables.sql
mysql -h localhost -P 3306 -u sqluser -psqlpass123 sqlExpert < datawarehouse/sql/03_dwd_tables.sql
mysql -h localhost -P 3306 -u sqluser -psqlpass123 sqlExpert < datawarehouse/sql/04_dws_tables.sql
mysql -h localhost -P 3306 -u sqluser -psqlpass123 sqlExpert < datawarehouse/sql/05_ads_tables.sql
```

2. 生成测试数据
```bash
python datawarehouse/sql/06_generate_test_data.py
```

3. 创建调度任务
- DolphinScheduler: 运行 `create_dolphinscheduler_tasks.py`
- Airflow: DAG文件已创建在 `airflow/dags/` 目录

## 数据库连接信息

- 主机: localhost
- 端口: 3306
- 数据库: sqlExpert
- 用户: sqluser
- 密码: sqlpass123

## 复杂SQL说明

`07_complex_etl.sql` 包含超过100行的复杂ETL SQL，实现从ODS到DWD到DWS到ADS的完整数据流转，包括：
- 数据清洗和转换
- 数据汇总计算
- 多表关联
- 复杂业务逻辑处理
