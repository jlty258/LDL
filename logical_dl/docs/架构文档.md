# 数仓解耦与多数据库迁移架构文档

## 1. 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-01-10
- **作者**: 数据平台团队
- **审核状态**: 待审核

## 2. 项目背景

### 2.1 现状分析

当前数仓系统存在以下问题：
- **数据库绑定**: 业务逻辑与 MySQL 深度耦合，使用大量 MySQL 特有语法
- **迁移困难**: 无法快速迁移到 PostgreSQL、Greenplum 等 MPP 数据库
- **维护成本高**: SQL 脚本分散，缺乏统一管理和版本控制
- **测试不足**: 缺乏自动化测试和数据质量保障机制
- **文档缺失**: 业务逻辑缺乏文档化，依赖关系不清晰

### 2.2 业务需求

- **多数据库支持**: 支持 MySQL、PostgreSQL、Greenplum、ClickHouse 等
- **一键迁移**: 能够快速在不同数据库间切换
- **分域迁移**: 支持按业务域（销售、生产、库存等）逐步迁移
- **零停机**: 生产环境迁移不影响业务
- **可维护性**: 代码可读、可测试、可文档化

## 3. 架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    调度层 (Scheduler Layer)                  │
│  ┌──────────────────┐         ┌──────────────────┐         │
│  │ DolphinScheduler │         │    Airflow       │         │
│  │   (现有系统)     │         │   (可选)         │         │
│  └──────────────────┘         └──────────────────┘         │
│           │                            │                   │
│           └────────────┬───────────────┘                   │
│                        │                                   │
└────────────────────────┼───────────────────────────────────┘
                         │
┌────────────────────────┼───────────────────────────────────┐
│                   业务逻辑层 (Logic Layer)                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              SQLMesh (核心 ETL 层)                  │   │
│  │  - 增量更新处理                                      │   │
│  │  - 历史数据回溯                                      │   │
│  │  - 版本化管理                                        │   │
│  │  - 零停机部署                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                        │                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              dbt (辅助层)                            │   │
│  │  - 数据质量测试                                      │   │
│  │  - 文档生成                                          │   │
│  │  - 简单报表                                          │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┼───────────────────────────────────┘
                         │
┌────────────────────────┼───────────────────────────────────┐
│                数据库适配器层 (Adapter Layer)                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  MySQL   │  │PostgreSQL │  │Greenplum │  │ClickHouse│ │
│  │ Adapter  │  │ Adapter   │  │ Adapter  │  │ Adapter  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└────────────────────────┼───────────────────────────────────┘
                         │
┌────────────────────────┼───────────────────────────────────┐
│                   数据存储层 (Storage Layer)                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  MySQL   │  │PostgreSQL │  │Greenplum │  │ClickHouse│ │
│  │ 8.0      │  │   15      │  │  6.x     │  │  23.x    │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技术选型

#### 3.2.1 SQLMesh（核心 ETL 层）

**选择理由**:
- ✅ 原生支持增量更新，无需手动处理 `ON DUPLICATE KEY UPDATE`
- ✅ 内置历史数据回溯（backfill）功能
- ✅ 版本化表名，支持零停机部署
- ✅ 自动处理数据库差异
- ✅ 计划系统，变更前预览

**适用场景**:
- DWD 层：复杂增量更新的事实表
- DWS 层：需要历史回溯的汇总表
- 核心业务逻辑：复杂的多表关联和计算

#### 3.2.2 dbt（辅助层）

**选择理由**:
- ✅ 成熟的测试框架
- ✅ 自动文档生成
- ✅ 丰富的社区包（dbt_utils, dbt_expectations）
- ✅ 简单易用，学习成本低

**适用场景**:
- Staging 层：简单的数据清洗
- 数据质量测试：所有层的测试
- 文档生成：自动生成数据字典
- 简单报表：ADS 层的部分报表

### 3.3 分层架构

```
┌─────────────────────────────────────────────────┐
│              ADS 层 (应用数据服务层)              │
│  - ads_sales_analysis                            │
│  - ads_production_analysis                       │
│  - ads_inventory_analysis                        │
│  工具: dbt (测试 + 文档)                         │
└─────────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────────┐
│              DWS 层 (数据汇总层)                 │
│  - dws_order_daily                              │
│  - dws_production_daily                          │
│  - dws_inventory_daily                           │
│  工具: SQLMesh (增量 + 历史回溯)                 │
└─────────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────────┐
│              DWD 层 (数据明细层)                 │
│  - dwd_order_fact                               │
│  - dwd_production_fact                           │
│  - dwd_inventory_fact                            │
│  工具: SQLMesh (复杂增量更新)                   │
└─────────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────────┐
│              ODS 层 (操作数据存储层)             │
│  - ods_order_master                              │
│  - ods_order_detail                               │
│  - ods_customer_master                            │
│  工具: dbt (简单清洗)                            │
└─────────────────────────────────────────────────┘
```

### 3.4 业务域划分

```
┌─────────────────────────────────────────────────┐
│              业务域架构                          │
├─────────────────────────────────────────────────┤
│  Sales (销售域)                                 │
│  ├── ODS: ods_order_*, ods_customer_*          │
│  ├── DWD: dwd_order_fact, dwd_customer_dim    │
│  ├── DWS: dws_order_daily                     │
│  └── ADS: ads_sales_analysis                   │
├─────────────────────────────────────────────────┤
│  Production (生产域)                            │
│  ├── ODS: ods_production_*, ods_bom_*          │
│  ├── DWD: dwd_production_fact                  │
│  ├── DWS: dws_production_daily                 │
│  └── ADS: ads_production_analysis              │
├─────────────────────────────────────────────────┤
│  Inventory (库存域)                             │
│  ├── ODS: ods_inventory_*, ods_material_*      │
│  ├── DWD: dwd_inventory_fact, dwd_material_dim │
│  ├── DWS: dws_inventory_daily                  │
│  └── ADS: ads_inventory_analysis               │
├─────────────────────────────────────────────────┤
│  Purchase (采购域)                              │
│  ├── ODS: ods_purchase_*, ods_supplier_*       │
│  ├── DWD: dwd_purchase_fact                    │
│  ├── DWS: dws_purchase_daily                   │
│  └── ADS: ads_purchase_analysis                │
├─────────────────────────────────────────────────┤
│  Quality (质量域)                                │
│  ├── ODS: ods_quality_*, ods_defect_*         │
│  ├── DWD: dwd_quality_fact                     │
│  ├── DWS: dws_quality_daily                    │
│  └── ADS: ads_quality_analysis                 │
└─────────────────────────────────────────────────┘
```

## 4. 核心组件

### 4.1 SQLMesh 组件

#### 4.1.1 模型定义

```sql
-- 示例：订单事实表模型
MODEL (
  name dwd.order_fact,
  kind INCREMENTAL_BY_TIME_RANGE,
  time_column 'order_date',
  grain order_id,
  cron '@daily',
  start '2020-01-01',
  dialect postgres
);
```

#### 4.1.2 计划系统

- **计划创建**: `sqlmesh plan dev` - 预览变更
- **计划应用**: `sqlmesh plan dev --auto-apply` - 自动应用
- **计划回滚**: `sqlmesh rollback dev` - 回滚变更

#### 4.1.3 环境管理

- **dev**: 开发环境
- **staging**: 测试环境
- **prod**: 生产环境

### 4.2 dbt 组件

#### 4.2.1 项目结构

```
datawarehouse_dbt/
├── dbt_project.yml
├── profiles.yml
├── models/
│   ├── staging/
│   ├── intermediate/
│   └── marts/
├── macros/
├── tests/
└── seeds/
```

#### 4.2.2 测试框架

```yaml
models:
  - name: dwd_order_fact
    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000
          max_value: 10000000
```

### 4.3 数据库适配器

#### 4.3.1 配置管理

```yaml
# profiles.yml
datawarehouse:
  target: dev
  outputs:
    mysql:
      type: mysql
      server: localhost
      port: 3306
      schema: sqlExpert
    postgres:
      type: postgres
      host: localhost
      port: 5432
      dbname: sqlExpert
    greenplum:
      type: postgres  # Greenplum 兼容 PostgreSQL
      host: gp-master
      port: 5432
      dbname: sqlExpert
```

#### 4.3.2 语法适配

- **日期函数**: 自动适配 `DATE_SUB` vs `DATE_TRUNC`
- **字符串函数**: 自动适配 `CONCAT` vs `||`
- **增量更新**: 自动适配 `ON DUPLICATE KEY UPDATE` vs `ON CONFLICT`

## 5. 数据流设计

### 5.1 数据流转

```
源系统
  ↓
ODS 层 (dbt staging)
  ├── 数据清洗
  ├── 格式标准化
  └── 数据验证
  ↓
DWD 层 (SQLMesh intermediate)
  ├── 业务逻辑转换
  ├── 增量更新处理
  └── 历史数据回溯
  ↓
DWS 层 (SQLMesh marts)
  ├── 数据汇总
  ├── 时间维度聚合
  └── 历史回溯
  ↓
ADS 层 (dbt marts)
  ├── 业务报表
  ├── 数据测试
  └── 文档生成
```

### 5.2 增量更新策略

#### SQLMesh 增量更新

```sql
MODEL (
  name dwd.order_fact,
  kind INCREMENTAL_BY_TIME_RANGE,
  time_column 'order_date'
);

SELECT ...
WHERE order_date >= @start_ds AND order_date < @end_ds
```

#### dbt 增量更新

```sql
{{
    config(
        materialized='incremental',
        unique_key='order_id',
        incremental_strategy='merge'
    )
}}

SELECT ...
{% if is_incremental() %}
    WHERE order_date > (select max(order_date) from {{ this }})
{% endif %}
```

## 6. 调度集成

### 6.1 DolphinScheduler 集成

```python
# DolphinScheduler 任务定义
{
    'name': 'dbt_sales_staging',
    'type': 'SHELL',
    'params': {
        'rawScript': '''
cd /path/to/datawarehouse_dbt
dbt run --select staging.sales.* --target mysql
dbt test --select staging.sales.* --target mysql
        '''
    }
}
```

### 6.2 任务依赖

```
ODS 层任务
  ↓
DWD 层任务 (依赖 ODS)
  ↓
DWS 层任务 (依赖 DWD)
  ↓
ADS 层任务 (依赖 DWS)
```

## 7. 迁移策略

### 7.1 分域迁移

1. **Sales 域** (优先级 1)
   - 影响范围小
   - 业务逻辑相对简单
   - 作为试点

2. **Production 域** (优先级 2)
   - 核心业务
   - 需要充分测试

3. **其他域** (优先级 3-6)
   - 按依赖关系逐步迁移

### 7.2 迁移步骤

```
阶段一：SQL 分析 (1-2周)
  ├── 分析现有 SQL
  ├── 识别依赖关系
  └── 制定迁移计划

阶段二：工具搭建 (1周)
  ├── 搭建 SQLMesh 环境
  ├── 搭建 dbt 环境
  └── 配置数据库连接

阶段三：SQL 转换 (2-3周)
  ├── 转换 DWD 层
  ├── 转换 DWS 层
  └── 转换 ADS 层

阶段四：测试验证 (1周)
  ├── 数据一致性测试
  ├── 性能测试
  └── 功能测试

阶段五：调度集成 (1周)
  ├── DolphinScheduler 集成
  ├── 任务依赖配置
  └── 监控告警

阶段六：上线迁移 (1周)
  ├── 灰度发布
  ├── 全量迁移
  └── 验证监控
```

## 8. 非功能性需求

### 8.1 性能要求

- **ETL 执行时间**: 不超过现有系统的 120%
- **查询响应时间**: 不超过现有系统的 110%
- **并发处理**: 支持至少 10 个并发任务

### 8.2 可靠性要求

- **数据一致性**: 99.99%
- **任务成功率**: 99.5%
- **故障恢复时间**: < 30 分钟

### 8.3 可维护性要求

- **代码覆盖率**: > 80%
- **文档完整度**: 100%
- **测试用例**: 每个模型至少 3 个测试

## 9. 风险与应对

### 9.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| SQLMesh 社区支持不足 | 高 | 中 | 建立内部知识库，培养专家 |
| 数据库性能差异 | 中 | 高 | 充分性能测试，优化 SQL |
| 数据迁移失败 | 高 | 低 | 分域迁移，充分测试 |

### 9.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 迁移期间业务中断 | 高 | 低 | 零停机部署，灰度发布 |
| 数据不一致 | 高 | 中 | 数据一致性校验，回滚机制 |

## 10. 监控与运维

### 10.1 监控指标

- **任务执行状态**: 成功/失败/运行中
- **任务执行时间**: 每个任务的耗时
- **数据质量**: 记录数、空值率、异常值
- **资源使用**: CPU、内存、磁盘

### 10.2 告警机制

- **任务失败**: 立即告警
- **执行超时**: 超过阈值告警
- **数据异常**: 数据质量测试失败告警

## 11. 附录

### 11.1 术语表

- **ODS**: Operational Data Store，操作数据存储层
- **DWD**: Data Warehouse Detail，数据明细层
- **DWS**: Data Warehouse Summary，数据汇总层
- **ADS**: Application Data Service，应用数据服务层
- **MPP**: Massively Parallel Processing，大规模并行处理

### 11.2 参考文档

- SQLMesh 官方文档: https://sqlmesh.readthedocs.io/
- dbt 官方文档: https://docs.getdbt.com/
- DolphinScheduler 文档: https://dolphinscheduler.apache.org/
