# 数仓迁移指南

## 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install sqlmesh dbt-core dbt-postgres dbt-mysql

# 配置环境变量
export MYSQL_PASSWORD="sqlpass123"
export POSTGRES_PASSWORD="postgres123"
```

### 2. 分析现有 SQL

```bash
# 分析现有 SQL 文件
python scripts/analyze_sql.py ../datawarehouse/sql

# 查看分析结果
cat analysis_results.json
```

### 3. 开始迁移

```bash
# 迁移单个业务域（示例：销售域）
python scripts/migrate_domain.py sales postgres
```

## 迁移步骤详解

### 步骤 1: SQL 分析

运行分析工具，了解现有 SQL 的：
- 依赖关系
- 增量更新模式
- 复杂度
- 数据库特定语法

### 步骤 2: 选择工具

根据分析结果选择：
- **SQLMesh**: 复杂增量更新、历史回溯
- **dbt**: 简单转换、测试和文档

### 步骤 3: SQL 转换

将 MySQL SQL 转换为：
- SQLMesh 模型格式
- dbt 模型格式

### 步骤 4: 分域迁移

按业务域逐步迁移：
1. Sales 域（试点）
2. Production 域
3. 其他域

### 步骤 5: 验证测试

- 数据一致性验证
- 性能测试
- 功能测试

### 步骤 6: 调度集成

集成到 DolphinScheduler：
- 配置任务
- 设置依赖
- 监控告警

## 常见问题

### Q: 如何选择 SQLMesh 还是 dbt？

A: 参考分析结果中的 `migration_recommendation` 字段。

### Q: 迁移失败怎么办？

A: 检查依赖关系，确保依赖域已迁移。

### Q: 如何验证数据一致性？

A: 使用 `verify_data.py` 脚本。

## 参考

- [架构文档](架构文档.md)
- [详细设计文档](详细设计文档.md)
