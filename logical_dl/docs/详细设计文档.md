# 数仓解耦与多数据库迁移详细设计文档

## 1. 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-01-10
- **作者**: 数据平台团队
- **关联文档**: 架构文档 v1.0

## 2. 项目结构设计

### 2.1 目录结构

```
logical_dl/
├── docs/                         # 文档目录
│   ├── architecture.md           # 架构文档
│   ├── design.md                 # 设计文档
│   └── migration_guide.md        # 迁移指南
│
├── sqlmesh_project/              # SQLMesh 项目
│   ├── config.yaml              # SQLMesh 配置
│   ├── models/                  # SQLMesh 模型
│   │   ├── ods/                 # ODS 层模型
│   │   ├── dwd/                 # DWD 层模型
│   │   │   ├── sales/
│   │   │   │   └── order_fact.sql
│   │   │   ├── production/
│   │   │   └── ...
│   │   ├── dws/                 # DWS 层模型
│   │   └── ads/                 # ADS 层模型
│   ├── audits/                  # 审计规则
│   └── tests/                   # 测试文件
│
├── dbt_project/                  # dbt 项目
│   ├── dbt_project.yml          # dbt 项目配置
│   ├── profiles.yml              # 数据库连接配置
│   ├── models/                  # dbt 模型
│   │   ├── staging/             # Staging 层
│   │   ├── intermediate/        # Intermediate 层
│   │   └── marts/               # Marts 层
│   ├── macros/                  # 宏定义
│   │   ├── database_utils.sql   # 数据库工具宏
│   │   └── date_utils.sql      # 日期工具宏
│   ├── tests/                   # 测试文件
│   │   └── custom_tests/
│   └── seeds/                   # 种子数据
│
├── scripts/                      # 工具脚本
│   ├── analyze_sql.py           # SQL 分析工具
│   ├── convert_sql.py           # SQL 转换工具
│   ├── migrate_domain.py         # 分域迁移脚本
│   └── verify_data.py            # 数据验证脚本
│
└── config/                       # 配置文件
    ├── migration_plan.yaml      # 迁移计划
    ├── domain_mapping.yaml       # 业务域映射
    └── database_config.yaml      # 数据库配置
```

### 2.2 文件命名规范

- **SQLMesh 模型**: `{layer}_{domain}_{table_name}.sql`
  - 示例: `dwd_sales_order_fact.sql`
- **dbt 模型**: `{prefix}_{table_name}.sql`
  - 示例: `stg_order_master.sql`, `int_order_fact.sql`
- **测试文件**: `test_{model_name}.sql` 或 `{model_name}_test.yml`

## 3. SQLMesh 详细设计

### 3.1 配置文件设计

```yaml
# sqlmesh_project/config.yaml
gateways:
  mysql:
    connection:
      type: mysql
      host: localhost
      port: 3306
      user: sqluser
      password: ${MYSQL_PASSWORD}
      database: sqlExpert
      catalog: sqlExpert
  
  postgres:
    connection:
      type: postgres
      host: localhost
      port: 5432
      user: postgres
      password: ${POSTGRES_PASSWORD}
      database: sqlExpert
      catalog: sqlExpert
  
  greenplum:
    connection:
      type: postgres
      host: gp-master
      port: 5432
      user: gpadmin
      password: ${GP_PASSWORD}
      database: sqlExpert
      catalog: sqlExpert

default_gateway: mysql

model_defaults:
  dialect: postgres
  schema: default
  start: '2020-01-01'
  end: '2024-12-31'

environments:
  dev:
    start: '2020-01-01'
    end: '2024-12-31'
  
  staging:
    start: '2020-01-01'
    end: '2024-12-31'
  
  prod:
    start: '2020-01-01'
    end: '2024-12-31'
```

### 3.2 DWD 层模型设计

#### 3.2.1 订单事实表

```sql
-- models/dwd/sales/order_fact.sql
MODEL (
  name dwd.order_fact,
  kind INCREMENTAL_BY_TIME_RANGE,
  time_column 'order_date',
  grain order_id,
  cron '@daily',
  start '2020-01-01',
  dialect postgres
);

WITH order_master AS (
    SELECT * FROM {{ ref('ods.order_master') }}
    WHERE order_date >= @start_ds AND order_date < @end_ds
),

order_detail AS (
    SELECT * FROM {{ ref('ods.order_detail') }}
    WHERE order_date >= @start_ds AND order_date < @end_ds
),

customer_master AS (
    SELECT * FROM {{ ref('ods.customer_master') }}
)

SELECT 
    om.order_id,
    om.order_no,
    om.customer_id,
    od.product_id,
    DATE(om.order_date) as order_date,
    EXTRACT(YEAR FROM om.order_date) as order_year,
    EXTRACT(MONTH FROM om.order_date) as order_month,
    EXTRACT(QUARTER FROM om.order_date) as order_quarter,
    CASE 
        WHEN om.order_status IN ('待确认', '已确认', '生产中', '已完成') 
        THEN om.order_status
        ELSE '其他'
    END as order_status,
    COALESCE(od.amount, 0) as order_amount,
    COALESCE(od.quantity, 0) as order_quantity,
    COALESCE(od.unit_price, 0) as unit_price,
    om.sales_rep_id,
    om.warehouse_id,
    COALESCE(cm.region, '未知') as region,
    CURRENT_TIMESTAMP as create_time,
    CURRENT_TIMESTAMP as update_time
FROM order_master om
INNER JOIN order_detail od ON om.order_id = od.order_id
LEFT JOIN customer_master cm ON om.customer_id = cm.customer_id
WHERE om.order_status IS NOT NULL
  AND od.quantity > 0
  AND od.unit_price > 0
```

## 4. dbt 详细设计

### 4.1 项目配置

```yaml
# dbt_project/dbt_project.yml
name: 'datawarehouse_dbt'
version: '1.0.0'
config-version: 2

profile: 'datawarehouse'

model-paths: ["models"]
test-paths: ["tests"]
macro-paths: ["macros"]
seed-paths: ["seeds"]

target-path: "target"
clean-targets:
  - "target"
  - "dbt_packages"

models:
  datawarehouse_dbt:
    staging:
      materialized: view
      schema: staging
      tags: ['staging']
    intermediate:
      materialized: table
      schema: intermediate
      tags: ['intermediate']
    marts:
      materialized: table
      schema: marts
      tags: ['marts']

vars:
  start_date: '2020-01-01'
  timezone: 'Asia/Shanghai'
```

### 4.2 Staging 层设计

```sql
-- models/staging/sales/stg_order_master.sql
{{ config(
    materialized='view',
    schema='staging',
    tags=['sales', 'staging']
) }}

select
    order_id,
    order_no,
    customer_id,
    order_date,
    order_status,
    sales_rep_id,
    warehouse_id,
    create_time,
    update_time
from {{ source('raw', 'ods_order_master') }}
where order_date >= {{ var('start_date') }}
```

## 5. 工具脚本设计

### 5.1 SQL 分析工具

详见 `scripts/analyze_sql.py`

### 5.2 SQL 转换工具

详见 `scripts/convert_sql.py`

### 5.3 分域迁移脚本

详见 `scripts/migrate_domain.py`

## 6. 数据库配置设计

### 6.1 多数据库配置

```yaml
# config/database_config.yaml
databases:
  mysql:
    type: mysql
    host: localhost
    port: 3306
    database: sqlExpert
    username: sqluser
    password: ${MYSQL_PASSWORD}
    charset: utf8mb4
    connection_pool_size: 10
  
  postgres:
    type: postgres
    host: localhost
    port: 5432
    database: sqlExpert
    username: postgres
    password: ${POSTGRES_PASSWORD}
    schema: public
    connection_pool_size: 10
  
  greenplum:
    type: postgres
    host: gp-master
    port: 5432
    database: sqlExpert
    username: gpadmin
    password: ${GP_PASSWORD}
    schema: public
    connection_pool_size: 20
    # Greenplum 特定配置
    gp_distribution_policy: 'DISTRIBUTED BY (id)'
```

### 6.2 迁移计划配置

```yaml
# config/migration_plan.yaml
migration_plan:
  phases:
    - name: 准备阶段
      duration: 2
      tasks:
        - sql_analysis
        - tool_setup
        - environment_preparation
    
    - name: 试点迁移
      duration: 2
      domain: sales
      tasks:
        - convert_sql
        - migrate_staging
        - migrate_dwd
        - migrate_dws
        - migrate_ads
        - verify_data
    
    - name: 全面迁移
      duration: 4
      domains: [production, inventory, purchase, quality, cost]
      tasks:
        - convert_sql
        - migrate_all_layers
        - verify_data
        - performance_test
    
    - name: 上线阶段
      duration: 1
      tasks:
        - scheduler_integration
        - monitoring_setup
        - production_deployment

  rollback_plan:
    - backup_before_migration
    - keep_original_system_running
    - gradual_cutover
    - rollback_procedure
```

## 7. 测试设计

### 7.1 单元测试

详见 `tests/test_sql_converter.py`

### 7.2 集成测试

详见 `tests/test_migration.py`

### 7.3 数据一致性测试

详见 `tests/data_consistency_test.sql`

## 8. 部署设计

### 8.1 环境配置

详见 `deploy/setup_environment.sh`

### 8.2 部署流程

详见 `deploy/deployment.yaml`

## 9. 监控设计

### 9.1 监控指标

详见 `monitoring/metrics.py`

### 9.2 告警规则

详见 `monitoring/alerts.yaml`

## 10. 附录

### 10.1 代码示例

所有代码示例见各脚本文件。

### 10.2 参考资源

- SQLMesh 文档: https://sqlmesh.readthedocs.io/
- dbt 文档: https://docs.getdbt.com/
- DolphinScheduler: https://dolphinscheduler.apache.org/
